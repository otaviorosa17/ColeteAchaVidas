<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colete Acha Vidas</title>
    <style>
        #map {
            height: 90vh;
            width: 100%;
        }
        #slider-container {
            height: 10vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="slider-container">
        <label for="radius-slider">Raio do Círculo (km):</label>
        <input type="range" id="radius-slider" min="0.1" max="5" value="5" step="0.1">
        <span id="radius-value">5 km</span>
    </div>

    <script>
        async function loadGoogleMapsApi() {
            try {
                // Busca a API Key do backend
                const response = await fetch('/api/config');
                const data = await response.json();
                const apiKey = data.apiKey;

                // Adiciona o script do Google Maps dinamicamente
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            } catch (error) {
                console.error("Erro ao carregar a API Key:", error);
            }
        }

        let map;
        let circle;
        let ponto1;

        function initMap() {
            const localInicial = { lat: 0, lng: 0 };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 2,
                center: localInicial,
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(mostrarLocalizacaoUsuario, erroLocalizacao);
            } else {
                alert("Geolocalização não é suportada pelo seu navegador.");
            }

            const radiusSlider = document.getElementById("radius-slider");
            const radiusValue = document.getElementById("radius-value");

            radiusSlider.addEventListener("input", function () {
                const raioEmKm = Number(radiusSlider.value);
                radiusValue.textContent = `${raioEmKm} km`;

                // Atualiza o zoom do mapa baseado no valor do slider
                const novoZoom = calcularZoomParaRaio(raioEmKm);
                map.setZoom(novoZoom);

                // Atualiza o raio do círculo
                atualizarRaioCirculo(raioEmKm);
            });
        }

        function mostrarLocalizacaoUsuario(position) {
            ponto1 = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            };

            map.setCenter(ponto1);
            map.setZoom(18);

            new google.maps.Marker({
                position: ponto1,
                map: map,
                title: "Sua Localização",
            });

            // Inicializa o círculo com o valor de zoom atual
            circle = new google.maps.Circle({
                map: map,
                center: ponto1,
                radius: 5000, // Começa com um valor padrão (5 km)
                fillColor: "#FF0000",
                fillOpacity: 0.3,
                strokeColor: "#FF0000",
                strokeOpacity: 0.8,
                strokeWeight: 2,
            });
        }

        function atualizarRaioCirculo(raioEmKm) {
            const raioEmMetros = raioEmKm * 1000;
            if (circle) {
                circle.setRadius(raioEmMetros);
            }
        }

        // Função para calcular o zoom necessário para um determinado raio
        function calcularZoomParaRaio(raioKm) {
            // Definindo uma escala simples: a cada 1 km, o zoom muda em aproximadamente 2 níveis
            const zoomBase = 18; // Zoom inicial (ajustável conforme necessário)
            const distanciaEmMetros = raioKm * 1000;
            const zoomCalculado = Math.log2(40008000 / (distanciaEmMetros * 2));
            return Math.min(Math.max(zoomBase - zoomCalculado, 5), 20); // Limita o zoom entre 5 e 20
        }

        function erroLocalizacao() {
            alert("Não foi possível obter a localização. O mapa permanecerá com a visualização inicial.");
        }

        // Carrega a API do Google Maps
        loadGoogleMapsApi();
    </script>
</body>
</html>
